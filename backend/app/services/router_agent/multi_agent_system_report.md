# ë©€í‹° ì—ì´ì „íŠ¸ ì‹¤í–‰ ì‹œìŠ¤í…œ ìƒì„¸ ë³´ê³ ì„œ

ì‘ì„±ì¼: 2025-01-31

## ğŸ“Œ ì‹œìŠ¤í…œ ê°œìš”

ë©€í‹° ì—ì´ì „íŠ¸ ì‹¤í–‰ ì‹œìŠ¤í…œì€ ì‚¬ìš©ìì˜ ë³µí•©ì ì¸ ìš”ì²­ì„ ë¶„ì„í•˜ì—¬ ì—¬ëŸ¬ ì—ì´ì „íŠ¸ë¥¼ ì¡°í•©í•´ ì²˜ë¦¬í•˜ëŠ” ê³ ë„í™”ëœ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

### í•µì‹¬ íŠ¹ì§•
- **í†µí•© ì²˜ë¦¬**: ë‹¨ì¼/ë©€í‹° íƒœìŠ¤í¬ë¥¼ í•˜ë‚˜ì˜ íŒŒì´í”„ë¼ì¸ìœ¼ë¡œ ì²˜ë¦¬
- **ì§€ëŠ¥ì  ë¶„í•´**: GPT-4ë¥¼ í™œìš©í•œ íƒœìŠ¤í¬ ìë™ ë¶„í•´
- **ì˜ì¡´ì„± ê´€ë¦¬**: íƒœìŠ¤í¬ ê°„ ìˆœì„œì™€ ë°ì´í„° ì „ë‹¬ ìë™í™”
- **ë³‘ë ¬ ì²˜ë¦¬**: ë…ë¦½ì ì¸ íƒœìŠ¤í¬ë“¤ì˜ ë™ì‹œ ì‹¤í–‰

## ğŸ—ï¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ì‚¬ìš©ì ìš”ì²­     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ /api/chat/multi â”‚ (router_api.py)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TaskRouter     â”‚ (task_router.py)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚         â”‚          â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”
â”‚Agent1â”‚ â”‚Agent2â”‚ â”‚Agent3   â”‚ â”‚Agent4â”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ íŒŒì¼ êµ¬ì¡° ë° ê¸°ëŠ¥

### 1. **prompts/task_decomposition.py**

#### ëª©ì 
ì‚¬ìš©ì ì¿¼ë¦¬ë¥¼ ë¶„ì„í•˜ì—¬ ì‹¤í–‰ ê°€ëŠ¥í•œ íƒœìŠ¤í¬ë“¤ë¡œ ë¶„í•´í•˜ëŠ” í”„ë¡¬í”„íŠ¸ ê´€ë¦¬

#### ì£¼ìš” êµ¬ì„±ìš”ì†Œ
```python
TASK_DECOMPOSITION_PROMPT = """
# GPT-4ì—ê²Œ ì „ë‹¬ë˜ëŠ” í”„ë¡¬í”„íŠ¸
# ì¿¼ë¦¬ë¥¼ JSON í˜•ì‹ì˜ íƒœìŠ¤í¬ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜
"""

def get_task_decomposition_prompt(query: str) -> str:
    """í”„ë¡¬í”„íŠ¸ ìƒì„± í•¨ìˆ˜"""
```

#### ì¶œë ¥ í˜•ì‹
```json
{
    "tasks": [
        {
            "id": 0,
            "description": "íƒœìŠ¤í¬ ì„¤ëª…",
            "agent": "ì‚¬ìš©í•  ì—ì´ì „íŠ¸",
            "query": "ì—ì´ì „íŠ¸ì— ì „ë‹¬í•  ì¿¼ë¦¬",
            "depends_on": [],  // ì˜ì¡´ì„±
            "parallel_group": 0  // ë³‘ë ¬ ê·¸ë£¹
        }
    ],
    "execution_strategy": "sequential|parallel|mixed"
}
```

### 2. **task_router.py**

#### í´ë˜ìŠ¤: TaskRouter

##### ì´ˆê¸°í™”
```python
def __init__(self):
    self.client = AsyncOpenAI()  # GPT-4 í´ë¼ì´ì–¸íŠ¸
    self.router_agent = RouterAgent()  # ê¸°ì¡´ ë¼ìš°í„° ì¬í™œìš©
    self.agent_handlers = agent_handlers  # ì—ì´ì „íŠ¸ ì‹¤í–‰ í•¨ìˆ˜ë“¤
```

##### í•µì‹¬ ë©”ì„œë“œ

###### 1. process_query()
```python
async def process_query(self, query: str, session_id: str, messages: List[Dict]) -> Dict
```
- **ì—­í• **: ë©”ì¸ ì§„ì…ì , ì „ì²´ ì²˜ë¦¬ íë¦„ ê´€ë¦¬
- **ì²˜ë¦¬ ê³¼ì •**:
  1. íƒœìŠ¤í¬ ë¶„í•´ (_decompose_query)
  2. ì‹¤í–‰ ê³„íš ìˆ˜ë¦½ (_create_execution_plan)
  3. ë‹¨ì¼/ë©€í‹° ë¶„ê¸° ì²˜ë¦¬
  4. ê²°ê³¼ ë°˜í™˜

###### 2. _decompose_query()
```python
async def _decompose_query(self, query: str) -> List[Dict]
```
- **ì—­í• **: GPT-4ë¥¼ ì‚¬ìš©í•´ ì¿¼ë¦¬ë¥¼ íƒœìŠ¤í¬ë¡œ ë¶„í•´
- **ì…ë ¥**: "ê±°ë˜ì²˜ ë¶„ì„í•˜ê³  ë³´ê³ ì„œ ì‘ì„±í•´ì¤˜"
- **ì¶œë ¥**: [{task1}, {task2}] í˜•íƒœì˜ íƒœìŠ¤í¬ ë¦¬ìŠ¤íŠ¸

###### 3. _create_execution_plan()
```python
def _create_execution_plan(self, tasks: List[Dict]) -> Dict[str, List[int]]
```
- **ì—­í• **: ë³‘ë ¬ ì‹¤í–‰ ê·¸ë£¹ ìƒì„±
- **ì¶œë ¥ ì˜ˆì‹œ**:
```python
{
    0: [0, 1],  # ê·¸ë£¹ 0: íƒœìŠ¤í¬ 0,1 ë³‘ë ¬ ì‹¤í–‰
    1: [2]      # ê·¸ë£¹ 1: íƒœìŠ¤í¬ 2 ìˆœì°¨ ì‹¤í–‰
}
```

###### 4. _execute_single_task()
```python
async def _execute_single_task(self, task: Dict, session_id: str, messages: List[Dict]) -> str
```
- **ì—­í• **: ë‹¨ì¼ íƒœìŠ¤í¬ ì‹¤í–‰
- **ì²˜ë¦¬**: ì—ì´ì „íŠ¸ í•¸ë“¤ëŸ¬ í˜¸ì¶œ ë° ì—ëŸ¬ ì²˜ë¦¬

###### 5. _execute_multi_tasks()
```python
async def _execute_multi_tasks(self, tasks: List[Dict], execution_plan: Dict, 
                              session_id: str, messages: List[Dict]) -> Dict[int, Any]
```
- **ì—­í• **: ë©€í‹° íƒœìŠ¤í¬ ì‹¤í–‰ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜
- **íŠ¹ì§•**:
  - ê·¸ë£¹ë³„ ìˆœì°¨ ì‹¤í–‰
  - ê·¸ë£¹ ë‚´ ë³‘ë ¬ ì‹¤í–‰ (asyncio.gather)
  - ì˜ì¡´ì„± ìˆëŠ” íƒœìŠ¤í¬ì— ì´ì „ ê²°ê³¼ ì „ë‹¬

###### 6. _execute_task_with_context()
```python
async def _execute_task_with_context(self, task: Dict, previous_results: Dict[int, Any],
                                   session_id: str, messages: List[Dict]) -> Any
```
- **ì—­í• **: ì˜ì¡´ì„± ì²˜ë¦¬ ë° ì»¨í…ìŠ¤íŠ¸ ì „ë‹¬
- **ì²˜ë¦¬**: depends_on íƒœìŠ¤í¬ë“¤ì˜ ê²°ê³¼ë¥¼ í˜„ì¬ ì¿¼ë¦¬ì— ì¶”ê°€

###### 7. _aggregate_results()
```python
def _aggregate_results(self, results: Dict[int, Any], tasks: List[Dict]) -> str
```
- **ì—­í• **: ë©€í‹° íƒœìŠ¤í¬ ê²°ê³¼ í†µí•©
- **ì¶œë ¥**: ë§ˆí¬ë‹¤ìš´ í˜•ì‹ì˜ í†µí•© ê²°ê³¼

### 3. **router_api.py ìˆ˜ì •ì‚¬í•­**

#### ìƒˆë¡œìš´ ì—”ë“œí¬ì¸íŠ¸
```python
@router.post("/chat/multi")
async def multi_task_chat(req: QueryRequest)
```

#### ì²˜ë¦¬ íë¦„
1. ì„¸ì…˜ ê´€ë¦¬
2. ë©”ì‹œì§€ ì €ì¥ (chat_history)
3. ì»¨í…ìŠ¤íŠ¸ ë¡œë“œ (ì´ì „ ëŒ€í™”)
4. ì»¨í…ìŠ¤íŠ¸ ë§¤ë‹ˆì € ì ìš© (ì°¸ì¡° í•´ê²°)
5. TaskRouter í˜¸ì¶œ
6. ê²°ê³¼ ì €ì¥ ë° ë°˜í™˜

## ğŸ”„ ë°ì´í„° íë¦„

### 1. ë‹¨ì¼ íƒœìŠ¤í¬ í”Œë¡œìš°
```
ì‚¬ìš©ì: "ê¹€ì² ìˆ˜ ì‹¤ì  ì¡°íšŒ"
    â†“
TaskRouter._decompose_query()
    â†“
[{task: "ê¹€ì² ìˆ˜ ì‹¤ì  ì¡°íšŒ", agent: "employee_agent"}]
    â†“
_execute_single_task()
    â†“
employee_agent ì‹¤í–‰
    â†“
ê²°ê³¼ ë°˜í™˜
```

### 2. ë©€í‹° íƒœìŠ¤í¬ í”Œë¡œìš°
```
ì‚¬ìš©ì: "ê±°ë˜ì²˜ ë¶„ì„í•˜ê³  ë³´ê³ ì„œ ì‘ì„±í•´ì¤˜"
    â†“
TaskRouter._decompose_query()
    â†“
[
  {id: 0, task: "ê±°ë˜ì²˜ ë¶„ì„", agent: "client_agent"},
  {id: 1, task: "ë³´ê³ ì„œ ì‘ì„±", agent: "docs_agent", depends_on: [0]}
]
    â†“
_create_execution_plan()
    â†“
{0: [0], 1: [1]}  // ìˆœì°¨ ì‹¤í–‰
    â†“
_execute_multi_tasks()
    â”œâ”€ ê·¸ë£¹ 0: client_agent ì‹¤í–‰
    â””â”€ ê·¸ë£¹ 1: docs_agent ì‹¤í–‰ (0ë²ˆ ê²°ê³¼ í¬í•¨)
    â†“
_aggregate_results()
    â†“
í†µí•© ê²°ê³¼ ë°˜í™˜
```

## ğŸ”— ìƒíƒœ(State) ì „ë‹¬ ë©”ì»¤ë‹ˆì¦˜

### 1. **ì„¸ì…˜ ìƒíƒœ**
- `session_id`: ëŒ€í™” ì„¸ì…˜ ì‹ë³„ì
- `messages`: ì´ì „ ëŒ€í™” ê¸°ë¡
- ëª¨ë“  í•¨ìˆ˜ í˜¸ì¶œ ì‹œ ì „ë‹¬

### 2. **íƒœìŠ¤í¬ ê°„ ìƒíƒœ ì „ë‹¬**
```python
# depends_onì„ í†µí•œ ì˜ì¡´ì„± ëª…ì‹œ
{
    "id": 2,
    "depends_on": [0, 1],  # 0, 1ë²ˆ íƒœìŠ¤í¬ ê²°ê³¼ í•„ìš”
    ...
}

# _execute_task_with_contextì—ì„œ ì²˜ë¦¬
if task.get("depends_on"):
    # ì´ì „ ê²°ê³¼ë¥¼ ì¿¼ë¦¬ì— ì¶”ê°€
    enhanced_query = previous_results + original_query
```

### 3. **ì»¨í…ìŠ¤íŠ¸ ë§¤ë‹ˆì € í†µí•©**
- ì›ë³¸ ì¿¼ë¦¬ â†’ ë³´ì™„ëœ ì¿¼ë¦¬ ë³€í™˜
- "ê·¸ ì‚¬ëŒ" â†’ "ê¹€ì² ìˆ˜" ê°™ì€ ì°¸ì¡° í•´ê²°
- sync_context_manager ì‚¬ìš© (ë™ê¸° í˜¸í™˜ì„±)

### 4. **ê²°ê³¼ ì €ì¥ ë° ì¶”ì **
```python
# ê° íƒœìŠ¤í¬ ê²°ê³¼ ì €ì¥
save_message(session_id, "assistant", response, {
    "type": "multi",
    "tasks": tasks,
    "detailed_results": results
})
```

## ğŸš€ ì‚¬ìš© ì˜ˆì‹œ

### API í˜¸ì¶œ
```bash
POST /api/chat/multi
{
    "session_id": "session_123",
    "query": "ë¯¸ë¼í´ì˜ì› ê±°ë˜ì²˜ ë¶„ì„í•˜ê³  ì˜ì—… ì‹¤ì  ë¶„ì„í•œ ë‹¤ìŒ ë°©ë¬¸ë³´ê³ ì„œ ì‘ì„±í•´ì¤˜"
}
```

### ì‘ë‹µ í˜•íƒœ
```json
{
    "success": true,
    "response": "## ë¯¸ë¼í´ì˜ì› ê±°ë˜ì²˜ ë¶„ì„\n...\n\n## ì˜ì—… ì‹¤ì  ë¶„ì„\n...\n\n## ë°©ë¬¸ë³´ê³ ì„œ\n...",
    "type": "multi",
    "tasks": [...],
    "detailed_results": {
        "0": "ê±°ë˜ì²˜ ë¶„ì„ ê²°ê³¼...",
        "1": "ì‹¤ì  ë¶„ì„ ê²°ê³¼...",
        "2": "ë³´ê³ ì„œ ë‚´ìš©..."
    }
}
```

## ğŸ”§ í™•ì¥ í¬ì¸íŠ¸

1. **ìƒˆë¡œìš´ ì—ì´ì „íŠ¸ ì¶”ê°€**
   - handlers.pyì— í•¸ë“¤ëŸ¬ ë“±ë¡
   - task_decomposition í”„ë¡¬í”„íŠ¸ ì—…ë°ì´íŠ¸

2. **ì‹¤í–‰ ì „ëµ ì¶”ê°€**
   - ì¡°ê±´ë¶€ ì‹¤í–‰
   - ë°˜ë³µ ì‹¤í–‰
   - ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ ê²½ë¡œ

3. **ì„±ëŠ¥ ìµœì í™”**
   - ìºì‹± ë©”ì»¤ë‹ˆì¦˜
   - íƒœìŠ¤í¬ ìš°ì„ ìˆœìœ„
   - ë¦¬ì†ŒìŠ¤ ì œí•œ

## ğŸ“Š ì‹œìŠ¤í…œ ì¥ì 

1. **ìœ ì—°ì„±**: ë‹¨ì¼/ë©€í‹° í†µí•© ì²˜ë¦¬
2. **í™•ì¥ì„±**: ìƒˆë¡œìš´ íŒ¨í„´ ì‰½ê²Œ ì¶”ê°€
3. **íš¨ìœ¨ì„±**: ë³‘ë ¬ ì²˜ë¦¬ë¡œ ì„±ëŠ¥ í–¥ìƒ
4. **ì¶”ì ì„±**: ê° ë‹¨ê³„ë³„ ë¡œê¹… ë° ì €ì¥
5. **í˜¸í™˜ì„±**: ê¸°ì¡´ ì‹œìŠ¤í…œê³¼ ì™„ë²½ í˜¸í™˜